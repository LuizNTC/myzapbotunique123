<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/boxicons/2.1.1/css/boxicons.min.css" rel="stylesheet">
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap");
    :root {
      --header-height: 3rem;
      --nav-width: 68px;
      --first-color: #F26764;
      --first-color-light: #ffd9d9;
      --white-color: #F7F6FB;
      --body-font: 'Nunito', sans-serif;
      --normal-font-size: 1rem;
      --z-fixed: 100;
    }
    *, ::before, ::after {
      box-sizing: border-box;
    }
    body {
      position: relative;
      margin: var(--header-height) 0 0 0;
      padding: 0 1rem;
      font-family: var(--body-font);
      font-size: var(--normal-font-size);
      transition: .5s;
    }
    a {
      text-decoration: none;
    }
    .header {
      width: 100%;
      height: var(--header-height);
      position: fixed;
      top: 0;
      left: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 1rem;
      background-color: var(--white-color);
      z-index: var(--z-fixed);
      transition: .5s;
    }
    .header_toggle {
      color: var(--first-color);
      font-size: 1.5rem;
      cursor: pointer;
    }
    .header_img {
      width: 35px;
      height: 35px;
      display: flex;
      justify-content: center;
      border-radius: 50%;
      overflow: hidden;
    }
    .header_img img {
      width: 40px;
    }
    .l-navbar {
      position: fixed;
      top: 0;
      left: 0;
      width: var(--nav-width);
      height: 100vh;
      background-color: var(--first-color);
      padding: .5rem 1rem 0 0;
      transition: .5s;
      z-index: var(--z-fixed);
    }
    .nav {
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      overflow: hidden;
    }
    .nav_logo, .nav_link {
      display: grid;
      grid-template-columns: max-content max-content;
      align-items: center;
      column-gap: 1rem;
      padding: .5rem 0 .5rem 1.5rem;
    }
    .nav_logo {
      margin-bottom: 2rem;
    }
    .nav_logo-icon {
      font-size: 1.25rem;
      color: var(--white-color);
    }
    .nav_logo-name {
      color: var(--white-color);
      font-weight: 700;
    }
    .nav_link {
      position: relative;
      color: var(--first-color-light);
      margin-bottom: 1.5rem;
      transition: .3s;
    }
    .nav_link:hover {
      color: var(--white-color);
    }
    .nav_icon {
      font-size: 1.25rem;
    }
    .show {
      left: 0;
    }
    .body-pd {
      padding-left: calc(var(--nav-width) + 1rem);
    }
    .active {
      color: var(--white-color);
    }
    .active::before {
      content: '';
      position: absolute;
      left: 0;
      width: 2px;
      height: 32px;
      background-color: var(--white-color);
    }
    .height-100 {
      height: 100vh;
    }
    #qr-code {
      width: 300px;
      height: 300px;
      margin-top: 20px; /* Adicionado para dar espaçamento ao QR Code */
    }
    @media screen and (min-width: 768px) {
      body {
        margin: calc(var(--header-height) + 1rem) 0 0 0;
        padding-left: calc(var(--nav-width) + 2rem);
      }
      .header {
        height: calc(var(--header-height) + 1rem);
        padding: 0 2rem 0 calc(var(--nav-width) + 2rem);
      }
      .header_img {
        width: 40px;
        height: 40px;
      }
      .header_img img {
        width: 45px;
      }
      .l-navbar {
        left: 0;
        padding: 1rem 1rem 0 0;
      }
      .show {
        width: calc(var(--nav-width) + 156px);
      }
      .body-pd {
        padding-left: calc(var(--nav-width) + 188px);
      }
    }
    @media screen and (max-width: 768px) {
      .l-navbar {
        left: -100%;
      }
      .show {
        left: 0;
      }
      .body-pd {
        padding-left: 1rem;
      }
    }
  </style>
</head>
<body id="body-pd" class="body-pd">
  <header class="header body-pd" id="header">
    <div class="header_toggle"> <i class='bx bx-menu' id="header-toggle"></i> </div>
    <div class="header_img"> <img src="https://i.imgur.com/hczKIze.jpg" alt=""> </div>
  </header>
  <div class="l-navbar show" id="nav-bar">
    <nav class="nav">
      <div> <a href="dashboard.html" class="nav_logo"> <i class='bx bx-layer nav_logo-icon'></i> <span class="nav_logo-name">ZapLite</span> </a>
        <div class="nav_list"> <a href="#" class="nav_link active"> <i class='bx bx-grid-alt nav_icon'></i> <span class="nav_name">Dashboard</span> </a> 
          <a href="#" class="nav_link"> <i class='bx bx-user nav_icon'></i> <span class="nav_name">Users</span> </a> 
          <a href="#" class="nav_link"> <i class='bx bx-message-square-detail nav_icon'></i> <span class="nav_name">Messages</span> </a> 
          <a href="#" class="nav_link"> <i class='bx bx-bookmark nav_icon'></i> <span class="nav_name">Bookmark</span> </a> 
          <a href="#" class="nav_link"> <i class='bx bx-folder nav_icon'></i> <span class="nav_name">Files</span> </a> 
          <a href="#" class="nav_link"> <i class='bx bx-bar-chart-alt-2 nav_icon'></i> <span class="nav_name">Stats</span> </a> 
        </div>
      </div> 
      <a href="index.html" class="nav_link"> <i class='bx bx-log-out nav_icon'></i> <span class="nav_name">SignOut</span> </a>
    </nav>
  </div>
  <!--exibição qr code-->
  <div class="height-100 bg-light">
    <h4>Main Components</h4>
    <button id="start-bot" class="btn btn-success btn-block mt-4">Start Bot</button>
    <button id="stop-bot" class="btn btn-danger btn-block mt-4">Stop Bot</button>
    <div class="form-group">
      <label for="prompt">Prompt:</label>
      <textarea class="form-control" id="prompt" rows="3"></textarea>
      <button id="save-prompt" class="btn btn-primary btn-block mt-2">Save Prompt</button>
    </div>
    <div id="qr-code-container">
      <img id="qr-code" src="" alt="QR Code" style="display: none;">
    </div>
    <div id="status">Waiting to start...</div> <!-- Adicionado para mostrar status -->
  </div>
  <!--Container Main end-->

  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
 
  <script>
    // Adicionando função de animação do menu lateral
    document.addEventListener("DOMContentLoaded", function(event) {
      const showNavbar = (toggleId, navId, bodyId, headerId) => {
        const toggle = document.getElementById(toggleId),
              nav = document.getElementById(navId),
              bodypd = document.getElementById(bodyId),
              headerpd = document.getElementById(headerId);
        if (toggle && nav && bodypd && headerpd) {
          toggle.addEventListener('click', () => {
            nav.classList.toggle('show');
            toggle.classList.toggle('bx-x');
            bodypd.classList.toggle('body-pd');
            headerpd.classList.toggle('body-pd');
          });
        }
      };
      showNavbar('header-toggle', 'nav-bar', 'body-pd', 'header');
      const linkColor = document.querySelectorAll('.nav_link');
      function colorLink() {
        if (linkColor) {
          linkColor.forEach(l => l.classList.remove('active'));
          this.classList.add('active');
        }
      }
      linkColor.forEach(l => l.addEventListener('click', colorLink));

      // Carregar o prompt do usuário ao carregar a página
      const userId = localStorage.getItem('userId'); // Assumindo que o userId foi salvo no login
      if (userId) {
        fetch('/get-prompt', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ userId })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success && data.prompt) {
            document.getElementById('prompt').value = data.prompt;
          }
        });
      }
    });

    // Função de salvamento do prompt
    const savePromptButton = document.getElementById('save-prompt');
    savePromptButton.addEventListener('click', () => {
      const prompt = document.getElementById('prompt').value;
      const userId = localStorage.getItem('userId'); // Assumindo que o userId foi salvo no login
      fetch('/set-prompt', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ userId, prompt })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Prompt saved successfully');
        } else {
          alert('Failed to save prompt');
        }
      });
    });

    // Iniciar e parar bot
    const startBotButton = document.getElementById('start-bot');
    const stopBotButton = document.getElementById('stop-bot');
    const statusElement = document.getElementById('status');
    const qrCodeImage = document.getElementById('qr-code');

    startBotButton.addEventListener('click', () => {
      statusElement.textContent = 'Bot started successfully. Waiting for QR Code...';

      fetch('/start-bot', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ userId: localStorage.getItem('userId') })
      }).then(response => response.json())
        .then(data => {
          if (data.success) {
            console.log('Bot started');
          } else {
            console.error('Failed to start bot:', data.message);
            statusElement.textContent = 'Failed to start bot';
          }
        });
    });

    stopBotButton.addEventListener('click', () => {
      fetch('/stop-bot', {
        method: 'POST'
      }).then(response => response.json())
        .then(data => {
          if (data.success) {
            qrCodeImage.style.display = 'none';
            statusElement.textContent = 'Bot stopped successfully';
            console.log('Bot stopped');
          } else {
            console.error('Failed to stop bot:', data.message);
            statusElement.textContent = 'Failed to stop bot';
          }
        });
    });

    const ws = new WebSocket(`ws://${window.location.host}`);

    ws.onmessage = (event) => {
      const message = JSON.parse(event.data);

      if (message.status === 'qr_code') {
        qrCodeImage.src = message.data;
        qrCodeImage.style.display = 'block';
        statusElement.textContent = 'Scan the QR Code with your WhatsApp';
      } else if (message.status === 'connected') {
        statusElement.textContent = 'WhatsApp connected';
        qrCodeImage.style.display = 'none';
      }
    };
  </script>
</body>
</html>
